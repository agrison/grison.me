<!DOCTYPE html>
<html lang="fr">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>grison.me - @Autowired("geek")</title>
  <link href="/media/javascripts/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <link rel="stylesheet" href="/media/style/grison.css" />
  <link rel="shortcut icon" type="image/png" href="/media/images/favicon.png"/>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js"></script>
  <script src="/media/javascripts/main.js" charset="utf-8"></script>
</head>

<body>

  <header> 
    <h1><a href="/"><span>@Autowired </span>Geek</a></h1>
    <h2>Alexandre Grison</h2>
    <nav> 
      <ul> 
        <li><a href="/">Blog</a></li>
        <li><a href="/categories">Categories</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/projects">Projects</a></li>
        <li><a href="/ego" class="ego">Ego</a></li>
      </ul> 
    </nav>
  </header>

  <div id="content">
    <section class="posts">

	<div class="date">07-12 2011</div>
  <article><h1><a href="/2011/12/Did-You-Mean">Peter Norvig's Did You Mean ?</a></h1>

<p>Almost one year and a half ago, I did found something interesting on the web. An article of Peter Norvig explaining <a href="http://norvig.com/spell-correct.html">How to Write a Spelling Corrector</a>. At this time I found it brilliant and did implement it in OCaml (but lost it). I tried to shorten the provided Python version, and also the Java version made by <a href="http://raelcunha.com/spell-correct.php">Rael Cunha</a>. Eventually, I did come with a shortest version in both Java and Python. </p>

<p>A week ago I did get lost on gmail, and read the mail sent to both of them for I don't know what reason, and I thought I could post them here.</p>

<h1>Python 3</h1>

<p>It uses <code>lambdas</code>, <code>string.ascii_lowercase</code>, <code>collections.Counter</code> and dict comprehension to reduce the number of lines to only 15, which is the lowest we can find on Peter Norvig's page, equals to <a href="http://pacman.blog.br/wiki/index.php?title=Um_Corretor_Ortogr%C3%A1fico_em_GAWK">Tiago &quot;PacMan&quot; Peczenyj &dash; Awk</a> and <a href="http://www.jelovic.com/weblog/?p=201">Dejan Jelovic &dash; F#</a> implementation.</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">collections</span>

<span class="n">load</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">txt</span><span class="p">:</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&#39;[a-z]+&#39;</span><span class="p">,</span> <span class="n">txt</span><span class="o">.</span><span class="n">lower</span><span class="p">()))</span>
<span class="n">NWORDS</span> <span class="o">=</span> <span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;big.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">edits1</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
   <span class="n">splits</span> <span class="o">=</span> <span class="p">[(</span><span class="n">word</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">word</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
   <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">splits</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span> <span class="o">+</span> <span class="c"># deletes</span>
              <span class="p">[</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">splits</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="c"># transposes</span>
              <span class="p">[</span><span class="n">a</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">splits</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="k">if</span> <span class="n">b</span><span class="p">]</span> <span class="o">+</span> <span class="c"># replaces</span>
              <span class="p">[</span><span class="n">a</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">:]</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">splits</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">])</span> <span class="c"># inserts</span>

<span class="n">edits2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">word</span><span class="p">:</span> <span class="p">{</span><span class="n">e2</span> <span class="k">for</span> <span class="n">e1</span> <span class="ow">in</span> <span class="n">edits1</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="k">for</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">edits1</span><span class="p">(</span><span class="n">e1</span><span class="p">)</span> <span class="k">if</span> <span class="n">e2</span> <span class="ow">in</span> <span class="n">NWORDS</span><span class="p">}</span>

<span class="n">known</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">words</span><span class="p">:</span> <span class="p">{</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">words</span> <span class="k">if</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">NWORDS</span><span class="p">}</span>

<span class="k">def</span> <span class="nf">correct</span><span class="p">(</span><span class="n">word</span><span class="p">):</span>
   <span class="n">candidates</span> <span class="o">=</span> <span class="n">known</span><span class="p">([</span><span class="n">word</span><span class="p">])</span> <span class="ow">or</span> <span class="n">known</span><span class="p">(</span><span class="n">edits1</span><span class="p">(</span><span class="n">word</span><span class="p">))</span> <span class="ow">or</span> <span class="n">edits2</span><span class="p">(</span><span class="n">word</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[</span><span class="n">word</span><span class="p">]</span>
   <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">NWORDS</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>

<span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> -&gt; Did you mean </span><span class="si">%s</span><span class="s"> ?&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">correct</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>
</code></pre>
</div>

<p>Test and performance:</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span><span class="nb">time </span>python3 DidYouMean.py speling sujar roopm
speling -&gt; Did you mean spelling ?
sujar -&gt; Did you mean sugar ?
roopm -&gt; Did you mean room ?

real  0m2.030s
user  0m1.906s
sys   0m0.115s
</code></pre>
</div>

<h1>Java</h1>

<p>The Java version is almost equivalent to the on of <a href="http://raelcunha.com/spell-correct.php">Rael Cunha</a>. But it uses a trick to read all the file in one line. This way, the program takes only 32 lines.</p>

<div class="highlight"><pre><code class="java"><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.regex.*</span><span class="o">;</span>

<span class="kd">class</span> <span class="nc">DidYouMean</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">nWords</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;();</span>
    
    <span class="kd">public</span> <span class="nf">DidYouMean</span><span class="o">(</span><span class="n">String</span> <span class="n">file</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">contents</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Scanner</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">file</span><span class="o">)).</span><span class="na">useDelimiter</span><span class="o">(</span><span class="s">&quot;\\Z&quot;</span><span class="o">).</span><span class="na">next</span><span class="o">();</span>
        <span class="n">Matcher</span> <span class="n">m</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">&quot;[a-z]+&quot;</span><span class="o">).</span><span class="na">matcher</span><span class="o">(</span><span class="n">contents</span><span class="o">.</span><span class="na">toLowerCase</span><span class="o">());</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">find</span><span class="o">())</span> <span class="n">nWords</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">group</span><span class="o">(),</span> <span class="n">nWords</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">group</span><span class="o">())</span> <span class="o">?</span> <span class="n">nWords</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">group</span><span class="o">())</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">edits</span><span class="o">(</span><span class="n">String</span> <span class="n">w</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">w</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">w</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">+</span> <span class="n">w</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">));</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">w</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">1</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">w</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">+</span> <span class="n">w</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">)</span> <span class="o">+</span> <span class="n">w</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">w</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="o">));</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">w</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="k">for</span><span class="o">(</span><span class="kt">char</span> <span class="n">c</span><span class="o">=</span><span class="sc">&#39;a&#39;</span><span class="o">;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;z&#39;</span><span class="o">;</span> <span class="o">++</span><span class="n">c</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">w</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">+</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">+</span> <span class="n">w</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">));</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">w</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="k">for</span><span class="o">(</span><span class="kt">char</span> <span class="n">c</span><span class="o">=</span><span class="sc">&#39;a&#39;</span><span class="o">;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;z&#39;</span><span class="o">;</span> <span class="o">++</span><span class="n">c</span><span class="o">)</span> <span class="n">result</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">w</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">+</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">+</span> <span class="n">w</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">i</span><span class="o">));</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="nf">correct</span><span class="o">(</span><span class="n">String</span> <span class="n">word</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">nWords</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">word</span><span class="o">))</span> <span class="k">return</span> <span class="n">word</span><span class="o">;</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="n">edits</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
        <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">candidates</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
        <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="k">if</span><span class="o">(</span><span class="n">nWords</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">s</span><span class="o">))</span> <span class="n">candidates</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">nWords</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">s</span><span class="o">),</span><span class="n">s</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">candidates</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="k">return</span> <span class="n">candidates</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">candidates</span><span class="o">.</span><span class="na">keySet</span><span class="o">()));</span>
        <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span> <span class="o">:</span> <span class="n">list</span><span class="o">)</span> <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">w</span> <span class="o">:</span> <span class="n">edits</span><span class="o">(</span><span class="n">s</span><span class="o">))</span> <span class="k">if</span><span class="o">(</span><span class="n">nWords</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">w</span><span class="o">))</span> <span class="n">candidates</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">nWords</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">w</span><span class="o">),</span><span class="n">w</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">candidates</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">candidates</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Collections</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">candidates</span><span class="o">.</span><span class="na">keySet</span><span class="o">()))</span> <span class="o">:</span> <span class="n">word</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">DidYouMean</span> <span class="n">sp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DidYouMean</span><span class="o">(</span><span class="s">&quot;big.txt&quot;</span><span class="o">);</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="nl">arg:</span> <span class="n">args</span><span class="o">)</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">arg</span> <span class="o">+</span> <span class="s">&quot; -&gt; Did you mean &quot;</span> <span class="o">+</span> <span class="n">sp</span><span class="o">.</span><span class="na">correct</span><span class="o">(</span><span class="n">arg</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot; ?&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Trying the Java version too:</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span><span class="nb">time </span>java DidYouMean speling sujar roopm
speling -&gt; Did you mean spelling ?
sujar -&gt; Did you mean sugar ?
roopm -&gt; Did you mean room ?

real  0m1.425s
user  0m1.695s
sys   0m0.154s
</code></pre>
</div>

<p>It can probably be shortened using third parties libraries, but the initial goal of Rael Cunha was to use only standard Java.</p>

<h1>OCaml</h1>

<p>Finally I wanted to start again on my previous OCaml version, but this time using <code>Batteries Included</code>. Here is what I finally come with, a 17 lines program, which implements the did you mean:</p>

<div class="highlight"><pre><code class="ocaml"><span class="c">(* Open Awesomeness *)</span>
<span class="k">open</span> <span class="nc">Batteries</span><span class="o">;;</span>
<span class="c">(* Read the content of the given file *)</span>
<span class="k">let</span> <span class="n">read_file</span> <span class="n">filename</span> <span class="o">=</span> <span class="nn">File</span><span class="p">.</span><span class="n">with_file_in</span> <span class="n">filename</span> <span class="nn">IO</span><span class="p">.</span><span class="n">read_all</span><span class="o">;;</span>
<span class="c">(* Extract all words *)</span>
<span class="k">let</span> <span class="n">words</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[^a-zA-Z]+&quot;</span><span class="o">)</span> <span class="o">|-</span> <span class="nn">List</span><span class="p">.</span><span class="n">enum</span> <span class="o">|-</span> <span class="n">map</span> <span class="nn">String</span><span class="p">.</span><span class="n">lowercase</span><span class="o">;;</span>
<span class="c">(* Count word occurences *)</span>
<span class="k">let</span> <span class="n">train</span> <span class="n">tbl</span> <span class="o">=</span> <span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">w</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="n">prev</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find_default</span> <span class="n">tbl</span> <span class="n">w</span> <span class="mi">0</span> <span class="k">in</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">tbl</span> <span class="n">w</span> <span class="o">(</span><span class="n">prev</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));;</span>
<span class="c">(* Construct the alphabet *)</span>
<span class="k">let</span> <span class="n">alphabet</span> <span class="o">=</span> <span class="o">[?</span> <span class="nc">List</span><span class="o">:</span><span class="nn">String</span><span class="p">.</span><span class="n">of_char</span><span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="n">i</span><span class="o">)</span> <span class="o">|</span> <span class="n">i</span> <span class="o">&lt;-</span> <span class="mi">97</span> <span class="o">--</span> <span class="mi">122</span> <span class="o">?];;</span>
<span class="c">(* Convenience functions *)</span>
<span class="k">let</span> <span class="o">(+..),</span> <span class="n">slice</span><span class="o">,</span> <span class="n">sub</span><span class="o">,</span> <span class="n">length</span> <span class="o">=</span> <span class="nn">Enum</span><span class="p">.</span><span class="n">append</span><span class="o">,</span> <span class="nn">String</span><span class="p">.</span><span class="n">slice</span><span class="o">,</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span><span class="o">,</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span><span class="o">;;</span>
<span class="c">(* the edits function *)</span>
<span class="k">let</span> <span class="n">edits</span> <span class="n">w</span> <span class="o">=</span> <span class="k">let</span> <span class="n">splits</span> <span class="n">w</span> <span class="o">=</span> <span class="o">[?</span> <span class="o">(</span><span class="n">slice</span> <span class="o">~</span><span class="n">last</span><span class="o">:</span><span class="n">i</span> <span class="n">w</span><span class="o">,</span> <span class="n">slice</span> <span class="o">~</span><span class="n">first</span><span class="o">:</span><span class="n">i</span> <span class="n">w</span><span class="o">)</span> <span class="o">|</span> <span class="n">i</span> <span class="o">&lt;-</span> <span class="mi">0</span> <span class="o">--</span> <span class="o">(</span><span class="n">length</span> <span class="n">w</span><span class="o">)</span> <span class="o">?]</span> <span class="k">in</span>
   <span class="o">[?</span> <span class="n">a</span><span class="o">^(</span><span class="n">slice</span> <span class="o">~</span><span class="n">first</span><span class="o">:</span><span class="mi">1</span> <span class="n">b</span><span class="o">)</span> <span class="o">|</span> <span class="n">a</span><span class="o">,</span><span class="n">b</span> <span class="o">&lt;-</span> <span class="n">splits</span> <span class="n">w</span><span class="o">;</span> <span class="n">b</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="o">?]</span> <span class="o">+..</span>
   <span class="o">[?</span> <span class="n">a</span><span class="o">^(</span><span class="n">sub</span> <span class="n">b</span> <span class="mi">1</span> <span class="mi">1</span><span class="o">)^(</span><span class="n">sub</span> <span class="n">b</span> <span class="mi">0</span> <span class="mi">1</span><span class="o">)^(</span><span class="n">slice</span> <span class="o">~</span><span class="n">first</span><span class="o">:</span><span class="mi">2</span> <span class="n">b</span><span class="o">)</span> <span class="o">|</span> <span class="n">a</span><span class="o">,</span><span class="n">b</span> <span class="o">&lt;-</span> <span class="n">splits</span> <span class="n">w</span><span class="o">;</span> <span class="n">length</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?]</span> <span class="o">+..</span>
   <span class="nn">Enum</span><span class="p">.</span><span class="n">flatten</span> <span class="o">[?</span> <span class="o">[?</span> <span class="n">a</span><span class="o">^</span><span class="n">c</span><span class="o">^(</span><span class="n">slice</span> <span class="o">~</span><span class="n">first</span><span class="o">:</span><span class="mi">1</span> <span class="n">b</span><span class="o">)</span> <span class="o">|</span> <span class="n">a</span><span class="o">,</span><span class="n">b</span> <span class="o">&lt;-</span> <span class="n">splits</span> <span class="n">w</span><span class="o">;</span> <span class="n">b</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="o">?]</span> <span class="o">|</span> <span class="n">c</span> <span class="o">&lt;-</span> <span class="o">(</span><span class="n">alphabet</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">enum</span><span class="o">)</span> <span class="o">?]</span> <span class="o">+..</span>
   <span class="nn">Enum</span><span class="p">.</span><span class="n">flatten</span> <span class="o">[?</span> <span class="o">[?</span> <span class="n">a</span><span class="o">^</span><span class="n">c</span><span class="o">^</span><span class="n">b</span> <span class="o">|</span> <span class="n">a</span><span class="o">,</span><span class="n">b</span> <span class="o">&lt;-</span> <span class="n">splits</span> <span class="n">w</span><span class="o">;</span> <span class="n">b</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="o">?]</span> <span class="o">|</span> <span class="n">c</span> <span class="o">&lt;-</span> <span class="o">(</span><span class="n">alphabet</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">enum</span><span class="o">)</span> <span class="o">?]</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">of_enum</span><span class="o">;;</span>
<span class="c">(* load the words *)</span>
<span class="k">let</span> <span class="n">known</span> <span class="o">=</span> <span class="k">let</span> <span class="n">model</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">4096</span> <span class="k">in</span> <span class="s2">&quot;big.txt&quot;</span> <span class="o">|&gt;</span> <span class="n">read_file</span> <span class="o">|&gt;</span> <span class="o">(</span><span class="n">words</span> <span class="o">|-</span> <span class="n">train</span> <span class="n">model</span><span class="o">);</span>
   <span class="n">model</span> <span class="o">|&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">enum</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">of_enum</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">fast_sort</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(_,</span> <span class="n">c1</span><span class="o">)</span> <span class="o">(_,</span> <span class="n">c2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="n">c2</span> <span class="n">c1</span><span class="o">);;</span>
<span class="c">(* correct a word*)</span>
<span class="k">let</span> <span class="n">correct</span> <span class="n">word</span> <span class="o">=</span> <span class="k">let</span> <span class="n">k</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">fst</span> <span class="n">known</span> <span class="k">in</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">w</span> <span class="o">-&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">index_of</span> <span class="n">w</span> <span class="n">k</span><span class="o">)</span> <span class="o">(</span><span class="n">edits</span> <span class="n">word</span><span class="o">)</span> 
   <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">remove_all</span><span class="o">)(</span><span class="nc">None</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">min</span> <span class="o">|&gt;</span> <span class="nn">Option</span><span class="p">.</span><span class="n">get</span> <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">at</span> <span class="n">known</span> <span class="o">|&gt;</span> <span class="n">fst</span><span class="o">;;</span>
<span class="c">(* try it *)</span>
<span class="o">#</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">correct</span> <span class="o">[</span><span class="s2">&quot;sward&quot;</span><span class="o">;</span> <span class="s2">&quot;sujar&quot;</span><span class="o">;</span> <span class="s2">&quot;speling&quot;</span><span class="o">;</span> <span class="s2">&quot;roopm&quot;</span><span class="o">];;</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">string</span> <span class="kt">list</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;word&quot;</span><span class="o">;</span> <span class="s2">&quot;sugar&quot;</span><span class="o">;</span> <span class="s2">&quot;spelling&quot;</span><span class="o">;</span> <span class="s2">&quot;room&quot;</span><span class="o">]</span>
</code></pre>
</div>

<p>It's a bit verbose, even with the convenience functions for Enum appending, slicing and string operations. Without them we can reach the 15 lines, but then it becomes a mess to read.</p>

<p>It think it can be made faster by using a Hashtbl instead of a List in <code>known</code> and <code>correct</code>, because <code>List.index_of</code> takes some time to execute.</p>

<p>Enjoy <span style="font-size: 24px">&#x263a;</span></p>
</article>

	<div class="date">01-12 2011</div>
  <article><h1><a href="/2011/12/Vim-XML-Indent-on-Windows">Vim XML Indent on Windows</a></h1>

<p>Today I had some XML to check and I wanted to pretty format it inside gVim on my Windows 7 workstation. On Unix we've got <code>xmllint</code> who's able to pretty format XML content, but I did not have it on Windows.</p>

<p>I knew I could do something like <code>:%!xmllint</code> in Vim and bam it would work. All I was needing was that external program. Instead of searching on the web for a port from Cygwin or something else, I did write a little tiny xmllint in Java. After that I just had to create some <code>.bat</code> file in my <code>%PATH%</code> and it worked like a charm.</p>

<div class="highlight"><pre><code class="java"><span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.logging.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilderFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.w3c.dom.Document</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.InputSource</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.org.apache.xml.internal.serialize.*</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Xmllint</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOG</span> <span class="o">=</span> <span class="n">Logger</span><span class="o">.</span><span class="na">getAnonymousLogger</span><span class="o">();</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">formatStdIn</span><span class="o">());</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">LOG</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">Level</span><span class="o">.</span><span class="na">SEVERE</span><span class="o">,</span> <span class="s">&quot;Could not indent XML.&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="n">String</span> <span class="nf">formatStdIn</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">Document</span> <span class="n">doc</span> <span class="o">=</span> <span class="n">parseStdIn</span><span class="o">();</span>
        <span class="kd">final</span> <span class="n">OutputFormat</span> <span class="n">format</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OutputFormat</span><span class="o">(</span><span class="n">doc</span><span class="o">,</span> <span class="s">&quot;UTF-8&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span> <span class="o">{</span> <span class="o">{</span> <span class="n">setIndent</span><span class="o">(</span><span class="mi">3</span><span class="o">);</span> <span class="o">}</span> <span class="o">};</span>
        <span class="kd">final</span> <span class="n">Writer</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">();</span>
        <span class="k">new</span> <span class="nf">XMLSerializer</span><span class="o">(</span><span class="n">out</span><span class="o">,</span> <span class="n">format</span><span class="o">).</span><span class="na">serialize</span><span class="o">(</span><span class="n">doc</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">out</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="n">Document</span> <span class="nf">parseStdIn</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">InputSource</span> <span class="n">is</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputSource</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">in</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">().</span><span class="na">newDocumentBuilder</span><span class="o">().</span><span class="na">parse</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>This is no Ã¼bber-fancy Java, nothing hard to do, nor to understand. For sure, it is possible to enhance it so that it performs better.</p>

<p>I'm sure you know how to write a <code>.bat</code> file that will launch the Java program <span style="font-size: 20px">&#x263a;</span></p>

<div class="highlight"><pre><code class="java"><span class="nd">@ECHO</span> <span class="n">off</span>
<span class="n">java</span> <span class="n">Xmllint</span>
</code></pre>
</div>

<p>I did map the call to <code>xmllint</code> in my <code>vimrc</code> to the <code>F2</code> key with <code>map &lt;F2&gt; &lt;ESC&gt;:%!xmllint&lt;CR&gt;:setf xml&lt;CR&gt;</code>.</p>

<p>Before:
<p align="center"><img src="/media/images/vim1.png" alt="Vim" /></p></p>

<p>After:
<p align="center"><img src="/media/images/vim2.png" alt="Vim with pretty XML" /></p></p>

<p>I did a simple performance test, it's way behind <code>xmllint</code>, but it should suit my needs at least on Windows, especially for an implementation that took 5 minutes:</p>

<div class="highlight"><pre><code class="bash"><span class="nv">$ </span>wc sample.xml
    7712   26111  593764 sample.xml
<span class="nv">$ </span><span class="nb">time </span>cat sample.xml | java Xmllint
    real  0m1.109s
    user  0m1.317s
    sys   0m0.093s
<span class="nv">$ </span><span class="nb">time </span>xmllint --format sample.xml
   real  0m0.102s
   user  0m0.030s
   sys   0m0.016s
</code></pre>
</div>

<p>Enjoy your pretty XML in Vim on Windows <span style="font-size: 24px">&#x263a;</span></p>
</article>

	<div class="date">20-11 2011</div>
  <article><h1><a href="/2011/11/Unix-Prompt">Unix Prompt</a></h1>

<p>Arriving at my new working place, I wanted to install my own <code>.bashrc</code> and other <code>dotfiles</code>, like I had on my previous work station.</p>

<p>But this time, I wanted a distinguishable prompt with nice colors and still easy for the eyes. So I decided to go on with the <a href="http://ethanschoonover.com/solarized">Solarized</a> theme and installed it for PuTTY, Vim and other tools I use on a daily basis.</p>

<p>The next little challenge for me was to clearly differenciate the command line in my prompt (the things I type) with another color than the output that gets generated. After a few research on the net, I've found a solution that works pretty well.</p>

<p>I'm using bash, and here is a screen of PuTTY on my Windows 7 work station:</p>

<p align="center"><img src="/media/images/putty.png" alt="PuTTY with Unix Prompt" /></p>

<p>The solution was to use thre <code>trap</code> command to reset the colors before the shell outputs something, and let the color in white at the end of <code>PS1</code>.</p>

<p>Here is an excerpt of my <code>.bashrc</code></p>

<div class="highlight"><pre><code class="bash"><span class="c"># Reset</span>
<span class="nv">Color_Off</span><span class="o">=</span><span class="s1">&#39;\[\e[0m\]&#39;</span>       <span class="c"># Text Reset</span>

<span class="c"># Colors will work nice when used with &quot;Solarized&quot; palette.</span>
<span class="c"># Nothing new here</span>
<span class="nv">White</span><span class="o">=</span><span class="s1">&#39;\[\e[0;37m\]&#39;</span>        <span class="c"># White</span>
<span class="nv">BPurple</span><span class="o">=</span><span class="s1">&#39;\[\e[1;35m\]&#39;</span>      <span class="c"># Purple</span>
<span class="nv">Green</span><span class="o">=</span><span class="s1">&#39;\[\e[0;32m\]&#39;</span>        <span class="c"># Green</span>
<span class="nv">Blue</span><span class="o">=</span><span class="s1">&#39;\[\e[0;34m\]&#39;</span>         <span class="c"># Blue</span>
<span class="nv">Yellow</span><span class="o">=</span><span class="s1">&#39;\[\e[0;33m\]&#39;</span>       <span class="c"># Yellow</span>
<span class="nv">Purple</span><span class="o">=</span><span class="s1">&#39;\[\e[0;35m\]&#39;</span>       <span class="c"># Purple</span>
<span class="nv">BWhite</span><span class="o">=</span><span class="s1">&#39;\[\e[1;37m\]&#39;</span>       <span class="c"># White</span>

<span class="c"># custom prompt. </span>
<span class="c"># User input is colored in white</span>
<span class="c"># the trap will reset the colors before execution of commands</span>
<span class="nv">PS1</span><span class="o">=</span><span class="s2">&quot;${BPurple}\A ${Green}\u${Color_Off}@${Blue}\h${Color_Off}:[${Yellow}\w${Color_Off}]${Purple}\n$ ${BWhite}&quot;</span>

<span class="c"># reset color after prompt</span>
<span class="nb">trap</span> <span class="s2">&quot;echo -ne &#39;\e[0m&#39;&quot;</span> DEBUG
</code></pre>
</div>

<p>The <code>trap</code> command will execute <code>echo -ne '\e[Om'</code> before anything gets written on stdout, and thus will reset the color that was previously left to white. This is the only real trick in this post. Nevertheless, it's still pretty cool.</p>

<p>Enjoy your nice prompt <span style="font-size: 24px">&#x263a;</span></p>
</article>

	<div class="date">29-10 2011</div>
  <article><h1>Hello</h1>

<p><img src="/media/images/hellocat.jpg" alt="Hello" />
<p class="center">More is coming...</p></p>
</article>



    </section>
  </div>

  <footer>
    <div class="about">Hey! I'm built using super-hype technologies <span style="font-size: 18px">&#x263a;</span></div>
    <div class="contact"><a href="#social" class="lsocial">Contact</a></div>
	<br/>
	<div id="social" style="clear: both;">
		<img src="/media/images/facebook.png" alt="Reach me on facebook" title="facebook" /> <a href="https://www.facebook.com/alexandre.grison">alexandre.grison</a> &nbsp;&mdash;&nbsp;
		<img src="/media/images/tw.png" alt="Follow me on twitter" title="twitter" /> <a href="http://twitter.com/#!/algrison">@algrison</a> &nbsp;&mdash;&nbsp; 
		<img src="/media/images/linkedin.png" alt="Buy me on linkedin" title="linkedin" /> <a href="http://fr.linkedin.com/pub/alexandre-grison/39/ba6/b56">alexandre grison</a> &nbsp;&mdash;&nbsp; 
		<img src="/media/images/github.png" alt="Browse me on Github" title="github" /> <a href="http://github.com/agrison">agrison</a> &nbsp;&mdash;&nbsp;
		<img src="/media/images/flickr.png" alt="View my awesomeness on Flickr" title="flickr" /> <a href="http://www.flickr.com/photos/agrison/">agrison</a>
	</div>
  </footer>
</body>
</html>